<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jira Analytics Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better visual appeal */
        .chart-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #3b82f6;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #10b981;
        }
        
        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* Fallback chart styles */
        .chart-fallback {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-weight: 500;
        }

        /* Hide browser extension autofill overlays */
        [data-lastpass-icon-root], 
        [data-lastpass-root], 
        [id^="__BITWARDEN"], 
        [data-bitwarden], 
        div[style*="z-index: 2147483647"] {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Prevent extension context errors -->
    <script>
        // Suppress extension-related errors
        window.addEventListener('error', function(e) {
            if (e.message && (
                e.message.includes('Extension context invalidated') ||
                e.message.includes('autofill') ||
                e.message.includes('lastpass') ||
                e.message.includes('bitwarden')
            )) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        });
    </script>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Enhanced Logging System for Debugging
        const Logger = {
            debug: (category, message, data = null) => {
                const timestamp = new Date().toISOString();
                const logEntry = `[${timestamp}] [${category.toUpperCase()}] ${message}`;
                console.log(logEntry, data || '');
                
                // Store in session for Claude debugging
                const logs = JSON.parse(sessionStorage.getItem('dashboardLogs') || '[]');
                logs.push({ timestamp, category, message, data });
                if (logs.length > 100) logs.shift(); // Keep last 100 logs
                sessionStorage.setItem('dashboardLogs', JSON.stringify(logs));
            },
            
            error: (category, message, error = null) => {
                const timestamp = new Date().toISOString();
                const logEntry = `[${timestamp}] [ERROR:${category.toUpperCase()}] ${message}`;
                console.error(logEntry, error || '');
                
                const logs = JSON.parse(sessionStorage.getItem('dashboardLogs') || '[]');
                logs.push({ 
                    timestamp, 
                    category: `ERROR:${category}`, 
                    message, 
                    data: error ? { 
                        message: error.message, 
                        stack: error.stack,
                        name: error.name 
                    } : null 
                });
                if (logs.length > 100) logs.shift();
                sessionStorage.setItem('dashboardLogs', JSON.stringify(logs));
            },
            
            performance: (operation, duration, metadata = null) => {
                const message = `${operation} completed in ${duration}ms`;
                Logger.debug('PERFORMANCE', message, metadata);
            },
            
            state: (component, state, action = 'UPDATE') => {
                Logger.debug('STATE', `${component} ${action}`, state);
            },
            
            getLogs: () => JSON.parse(sessionStorage.getItem('dashboardLogs') || '[]'),
            
            clearLogs: () => sessionStorage.removeItem('dashboardLogs'),
            
            exportLogs: () => {
                const logs = Logger.getLogs();
                const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dashboard-logs-${new Date().toISOString()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
        };
        
        // Test Scenarios for Demo Data
        const TEST_SCENARIOS = {
            normal: {
                name: "Normal Load",
                description: "Typical production workload with realistic PL transitions",
                currentCounts: { high: 8, medium: 23, low: 67, total: 98 },
                tickets: [
                    { 
                        key: 'KSD-1001', 
                        summary: 'Database performance optimization needed', 
                        status: 'In Progress', 
                        priorityLevel: 5, 
                        ageInDays: 3, 
                        labels: ['src-tech-debt'],
                        created: '2025-06-29T09:00:00.000-0400',
                        priorityLevelTransitions: [],
                        incomingDate: '2025-06-29T09:00:00.000-0400',
                        outgoingDate: null,
                        isIncoming: true,
                        isOutgoing: false
                    },
                    { 
                        key: 'KSD-1002', 
                        summary: 'User authentication system enhancement', 
                        status: 'Open', 
                        priorityLevel: 25, 
                        ageInDays: 7, 
                        labels: ['src-enhancement'],
                        created: '2025-06-25T14:30:00.000-0400',
                        priorityLevelTransitions: [
                            {
                                timestamp: '2025-06-26T10:15:00.000-0400',
                                author: 'System Admin',
                                fromValue: null,
                                toValue: 50
                            },
                            {
                                timestamp: '2025-06-27T16:20:00.000-0400',
                                author: 'Project Manager',
                                fromValue: 50,
                                toValue: 25
                            }
                        ],
                        incomingDate: '2025-06-26T10:15:00.000-0400',
                        outgoingDate: null,
                        isIncoming: true,
                        isOutgoing: false
                    },
                    { 
                        key: 'KSD-1003', 
                        summary: 'API rate limiting implementation', 
                        status: 'Code Review', 
                        priorityLevel: 15, 
                        ageInDays: 12, 
                        labels: ['src-new-feature'],
                        created: '2025-06-20T11:00:00.000-0400',
                        priorityLevelTransitions: [],
                        incomingDate: '2025-06-20T11:00:00.000-0400',
                        outgoingDate: null,
                        isIncoming: true,
                        isOutgoing: false
                    },
                    { 
                        key: 'KSD-1004', 
                        summary: 'Frontend responsive design fixes', 
                        status: 'Testing', 
                        priorityLevel: 150, 
                        ageInDays: 5, 
                        labels: ['src-bug-fix'],
                        created: '2025-06-27T08:30:00.000-0400',
                        priorityLevelTransitions: [],
                        incomingDate: '2025-06-27T08:30:00.000-0400',
                        outgoingDate: '2025-06-27T08:30:00.000-0400',
                        isIncoming: true,
                        isOutgoing: true
                    },
                    { 
                        key: 'KSD-1005', 
                        summary: 'Memory leak investigation in production', 
                        status: 'Blocked', 
                        priorityLevel: 2, 
                        ageInDays: 15, 
                        labels: ['src-bug-fix'],
                        created: '2025-06-17T13:45:00.000-0400',
                        priorityLevelTransitions: [
                            {
                                timestamp: '2025-06-18T09:00:00.000-0400',
                                author: 'System Admin',
                                fromValue: null,
                                toValue: 50
                            },
                            {
                                timestamp: '2025-06-19T14:30:00.000-0400',
                                author: 'Tech Lead',
                                fromValue: 50,
                                toValue: 2
                            }
                        ],
                        incomingDate: '2025-06-18T09:00:00.000-0400',
                        outgoingDate: null,
                        isIncoming: true,
                        isOutgoing: false
                    }
                ]
            },
            
            priorityTransitions: {
                name: "Priority Transitions",
                description: "Tickets demonstrating incoming/outgoing behavior with PL changes",
                currentCounts: { high: 3, medium: 2, low: 3, total: 8 },
                tickets: [
                    {
                        key: 'KSD-2001',
                        summary: 'Critical security vulnerability - immediate fix needed',
                        status: 'In Progress',
                        priorityLevel: 1,
                        ageInDays: 2,
                        labels: ['src-bug-fix', 'critical'],
                        created: '2025-06-30T08:00:00.000-0400',
                        priorityLevelTransitions: [
                            {
                                timestamp: '2025-06-30T08:30:00.000-0400',
                                author: 'Security Team',
                                fromValue: null,
                                toValue: 1
                            }
                        ],
                        incomingDate: '2025-06-30T08:30:00.000-0400',
                        outgoingDate: null,
                        isIncoming: true,
                        isOutgoing: false
                    },
                    {
                        key: 'KSD-2002',
                        summary: 'Feature request escalated then deprioritized',
                        status: 'Open',
                        priorityLevel: 8,
                        ageInDays: 5,
                        labels: ['src-new-feature'],
                        created: '2025-06-27T10:00:00.000-0400',
                        priorityLevelTransitions: [
                            {
                                timestamp: '2025-06-28T09:00:00.000-0400',
                                author: 'System Admin',
                                fromValue: null,
                                toValue: 50
                            },
                            {
                                timestamp: '2025-06-29T14:30:00.000-0400',
                                author: 'Product Manager',
                                fromValue: 50,
                                toValue: 8
                            }
                        ],
                        incomingDate: '2025-06-28T09:00:00.000-0400',
                        outgoingDate: null,
                        isIncoming: true,
                        isOutgoing: false
                    },
                    {
                        key: 'KSD-2003',
                        summary: 'Documentation update downgraded',
                        status: 'Waiting',
                        priorityLevel: 200,
                        ageInDays: 8,
                        labels: ['src-tech-debt'],
                        created: '2025-06-24T15:00:00.000-0400',
                        priorityLevelTransitions: [
                            {
                                timestamp: '2025-06-24T15:30:00.000-0400',
                                author: 'System Admin',
                                fromValue: null,
                                toValue: 50
                            },
                            {
                                timestamp: '2025-06-26T11:00:00.000-0400',
                                author: 'Team Lead',
                                fromValue: 50,
                                toValue: 200
                            }
                        ],
                        incomingDate: '2025-06-24T15:30:00.000-0400',
                        outgoingDate: '2025-06-26T11:00:00.000-0400',
                        isIncoming: true,
                        isOutgoing: true
                    },
                    {
                        key: 'KSD-2004',
                        summary: 'Bug fix completed and PL cleared',
                        status: 'Closed',
                        priorityLevel: null,
                        ageInDays: 12,
                        labels: ['src-bug-fix'],
                        created: '2025-06-20T09:00:00.000-0400',
                        priorityLevelTransitions: [
                            {
                                timestamp: '2025-06-20T09:30:00.000-0400',
                                author: 'System Admin',
                                fromValue: null,
                                toValue: 25
                            },
                            {
                                timestamp: '2025-06-21T10:15:00.000-0400',
                                author: 'Developer',
                                fromValue: 25,
                                toValue: 5
                            },
                            {
                                timestamp: '2025-06-22T16:45:00.000-0400',
                                author: 'QA Team',
                                fromValue: 5,
                                toValue: null
                            }
                        ],
                        incomingDate: '2025-06-20T09:30:00.000-0400',
                        outgoingDate: '2025-06-22T16:45:00.000-0400',
                        isIncoming: true,
                        isOutgoing: true
                    },
                    {
                        key: 'KSD-2005',
                        summary: 'Task deprioritized to low importance',
                        status: 'Waiting',
                        priorityLevel: 150,
                        ageInDays: 8,
                        labels: ['src-tech-debt'],
                        created: '2025-06-24T11:00:00.000-0400',
                        priorityLevelTransitions: [
                            {
                                timestamp: '2025-06-24T11:30:00.000-0400',
                                author: 'System Admin',
                                fromValue: null,
                                toValue: 10
                            },
                            {
                                timestamp: '2025-06-26T14:20:00.000-0400',
                                author: 'Team Lead',
                                fromValue: 10,
                                toValue: 150
                            }
                        ],
                        incomingDate: '2025-06-24T11:30:00.000-0400',
                        outgoingDate: '2025-06-26T14:20:00.000-0400',
                        isIncoming: true,
                        isOutgoing: true
                    }
                ]
            },
            
            empty: {
                name: "Empty State",
                description: "No tickets or data available",
                currentCounts: { high: 0, medium: 0, low: 0, total: 0 },
                tickets: []
            }
        };
        
        // Check if Recharts loaded properly, otherwise use fallbacks
        const ChartsAvailable = typeof Recharts !== 'undefined' && Recharts.LineChart;
        
        // Recharts components or fallbacks
        const LineChart = ChartsAvailable ? Recharts.LineChart : ({ children, data, ...props }) => (
            <div className="chart-fallback" style={{ height: props.height || 300 }}>
                📈 Line Chart: {data?.length || 0} data points
            </div>
        );
        
        const BarChart = ChartsAvailable ? Recharts.BarChart : ({ children, data, ...props }) => (
            <div className="chart-fallback" style={{ height: props.height || 300 }}>
                📊 Bar Chart: {data?.length || 0} data points  
            </div>
        );
        
        const Line = ChartsAvailable ? Recharts.Line : () => null;
        const Bar = ChartsAvailable ? Recharts.Bar : () => null;
        const XAxis = ChartsAvailable ? Recharts.XAxis : () => null;
        const YAxis = ChartsAvailable ? Recharts.YAxis : () => null;
        const CartesianGrid = ChartsAvailable ? Recharts.CartesianGrid : () => null;
        const Tooltip = ChartsAvailable ? Recharts.Tooltip : () => null;
        const Legend = ChartsAvailable ? Recharts.Legend : () => null;
        const ResponsiveContainer = ChartsAvailable ? Recharts.ResponsiveContainer : ({ children, width, height }) => (
            <div style={{ width: width || '100%', height: height || 300 }}>
                {children}
            </div>
        );

        // Icons as simple SVG components
        const DatabaseIcon = () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
            </svg>
        );

        const RefreshIcon = ({ spinning }) => (
            <svg className={`w-4 h-4 ${spinning ? 'animate-spin' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
        );

        const SettingsIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );

        const CheckIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
        );

        const XIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
        );

        const AlertIcon = () => (
            <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.348 16.5c-.77.833.192 2.5 1.732 2.5z" />
            </svg>
        );

        const TrendingIcon = () => (
            <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
            </svg>
        );

        const ClockIcon = () => (
            <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        // Dashboard Configuration
        const DASHBOARD_CONFIG = {
            sections: [
                { id: 'overview', title: 'Current Status Cards', component: 'OverviewPanel', enabled: true },
                { id: 'trends', title: 'Historical Trend Chart', component: 'TrendsPanel', enabled: true },
                { id: 'sources', title: 'Source Label Analysis', component: 'SourcesPanel', enabled: true },
                { id: 'tickets', title: 'Recent Tickets Table', component: 'TicketsPanel', enabled: true }
            ],
            charts: {
                historical: {
                    type: 'line',
                    height: 300,
                    colors: {
                        high: '#ef4444',
                        medium: '#f59e0b',
                        low: '#3b82f6',
                        total: '#6b7280'
                    }
                },
                sourceLabels: {
                    type: 'bar',
                    height: 350,
                    stackId: 'a'
                },
                averageAge: {
                    type: 'line',
                    height: 250,
                    colors: {
                        highAvgAge: '#ef4444',
                        mediumAvgAge: '#f59e0b',
                        lowAvgAge: '#3b82f6'
                    }
                }
            },
            cards: {
                high: { color: 'red', icon: 'AlertIcon' },
                medium: { color: 'yellow', icon: 'TrendingIcon' },
                low: { color: 'blue', icon: 'ClockIcon' },
                total: { color: 'gray', icon: 'DatabaseIcon' }
            },
            labels: {
                sourceLabels: [
                    { name: 'Bug Fix', label: 'src-bug-fix', count: 45, percentage: 35, color: '#ef4444' },
                    { name: 'Golive Critical', label: 'src-golive-critical', count: 28, percentage: 22, color: '#dc2626' },
                    { name: 'New Feature', label: 'src-new-feature', count: 18, percentage: 14, color: '#3b82f6' },
                    { name: 'Integration', label: 'src-integration', count: 12, percentage: 9, color: '#8b5cf6' },
                    { name: 'Tech Debt', label: 'src-tech-debt', count: 10, percentage: 8, color: '#f59e0b' },
                    { name: 'Unknown', label: 'src-unknown', count: 6, percentage: 5, color: '#6b7280' },
                    { name: 'Maintenance', label: 'src-maintenance', count: 4, percentage: 3, color: '#10b981' },
                    { name: 'Enhancement', label: 'src-enhancement', count: 3, percentage: 2, color: '#ec4899' },
                    { name: 'Research', label: 'src-research', count: 2, percentage: 2, color: '#06b6d4' },
                    { name: 'Critical', label: 'src-critical', count: 1, percentage: 1, color: '#84cc16' }
                ]
            }
        };

        // Dashboard Panel Components
        const OverviewPanel = ({ realData }) => {
            if (!realData) return null;
            
            const cardData = [
                { key: 'high', label: 'High Priority', value: realData.currentCounts?.high || 0 },
                { key: 'medium', label: 'Medium Priority', value: realData.currentCounts?.medium || 0 },
                { key: 'low', label: 'Low Priority', value: realData.currentCounts?.low || 0 },
                { key: 'total', label: 'Total Active', value: realData.currentCounts?.total || 0 }
            ];
            
            const getCardIcon = (key) => {
                switch(key) {
                    case 'high': return <AlertIcon />;
                    case 'medium': return <TrendingIcon />;
                    case 'low': return <ClockIcon />;
                    default: return <DatabaseIcon />;
                }
            };
            
            const getCardColor = (key) => {
                const colors = {
                    high: { bg: 'bg-red-50', border: 'border-red-200', text: 'text-red-600', value: 'text-red-700' },
                    medium: { bg: 'bg-yellow-50', border: 'border-yellow-200', text: 'text-yellow-600', value: 'text-yellow-700' },
                    low: { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-600', value: 'text-blue-700' },
                    total: { bg: 'bg-gray-50', border: 'border-gray-200', text: 'text-gray-600', value: 'text-gray-700' }
                };
                return colors[key] || colors.total;
            };
            
            return (
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    {cardData.map(card => {
                        const colors = getCardColor(card.key);
                        return (
                            <div key={card.key} className={`${colors.bg} ${colors.border} border rounded-lg p-4`}>
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className={`${colors.text} text-sm font-medium`}>{card.label}</p>
                                        <p className={`text-3xl font-bold ${colors.value}`}>{card.value}</p>
                                    </div>
                                    {getCardIcon(card.key)}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };
        
        const TrendsPanel = ({ realData, jiraConfig, timePeriod, customDays, timeInterval }) => {
            if (!realData || !realData.historicalTrend) return null;
            
            const chartConfig = DASHBOARD_CONFIG.charts.historical;
            const title = `Historical Ticket Trends (${jiraConfig.project} Project) - ${
                timePeriod === 'custom' ? `Last ${customDays} days` : 
                timePeriod === '7d' ? 'Last 7 days' :
                timePeriod === '30d' ? 'Last 30 days' :
                timePeriod === '90d' ? 'Last 90 days' :
                timePeriod === '180d' ? 'Last 180 days' :
                timePeriod === '365d' ? 'Last year' : ''
            } (${timeInterval === 'daily' ? 'Daily' : timeInterval === 'weekly' ? 'Weekly' : 'Monthly'})`;
            
            return (
                <div className="chart-container p-6">
                    <h3 className="text-lg font-semibold mb-4">{title}</h3>
                    <ResponsiveContainer width="100%" height={chartConfig.height}>
                        <LineChart data={realData.historicalTrend}>
                            <CartesianGrid strokeDasharray="3 3" />
                            <XAxis 
                                dataKey="date" 
                                angle={timeInterval === 'monthly' ? -45 : 0}
                                textAnchor={timeInterval === 'monthly' ? 'end' : 'middle'}
                                height={timeInterval === 'monthly' ? 60 : 30}
                            />
                            <YAxis />
                            <Tooltip content={<CustomTooltip />} />
                            <Legend />
                            <Line type="monotone" dataKey="high" stroke={chartConfig.colors.high} strokeWidth={2} name="High Priority" />
                            <Line type="monotone" dataKey="medium" stroke={chartConfig.colors.medium} strokeWidth={2} name="Medium Priority" />
                            <Line type="monotone" dataKey="low" stroke={chartConfig.colors.low} strokeWidth={2} name="Low Priority" />
                            <Line type="monotone" dataKey="total" stroke={chartConfig.colors.total} strokeWidth={2} name="Total" />
                        </LineChart>
                    </ResponsiveContainer>
                </div>
            );
        };
        
        const SourcesPanel = ({ realData, timePeriod, customDays }) => {
            if (!realData) return null;
            
            const sourceLabelsConfig = DASHBOARD_CONFIG.charts.sourceLabels;
            const ageConfig = DASHBOARD_CONFIG.charts.averageAge;
            
            return (
                <div className="chart-container p-6">
                    <h3 className="text-lg font-semibold mb-4">Source Label Analysis Over Time</h3>
                    <p className="text-sm text-gray-600 mb-4">Charts show the number of source label occurrences per time period. Multiple labels per ticket are counted separately.</p>
                    
                    {realData.sourceLabelsTimeSeries && (
                        <div className="mb-6">
                            <h4 className="font-medium mb-3">Source Label Occurrences Over Time (Stacked)</h4>
                            <ResponsiveContainer width="100%" height={sourceLabelsConfig.height}>
                                <BarChart data={realData.sourceLabelsTimeSeries}>
                                    <CartesianGrid strokeDasharray="3 3" />
                                    <XAxis dataKey="date" />
                                    <YAxis label={{ value: 'Label Count', angle: -90, position: 'insideLeft' }} />
                                    <Tooltip content={<SourceLabelsTooltip />} />
                                    <Legend />
                                    {realData.sourceLabels?.map((source, index) => (
                                        <Bar 
                                            key={source.label} 
                                            dataKey={source.label} 
                                            stackId={sourceLabelsConfig.stackId} 
                                            fill={source.color} 
                                            name={source.name} 
                                        />
                                    ))}
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                    )}

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {realData.averageAgeTimeSeries && (
                            <div>
                                <h4 className="font-medium mb-3">Average Ticket Age Trends</h4>
                                <ResponsiveContainer width="100%" height={ageConfig.height}>
                                    <LineChart data={realData.averageAgeTimeSeries}>
                                        <CartesianGrid strokeDasharray="3 3" />
                                        <XAxis dataKey="date" />
                                        <YAxis />
                                        <Tooltip content={<CustomAgeTooltip />} />
                                        <Legend />
                                        <Line type="monotone" dataKey="highAvgAge" stroke={ageConfig.colors.highAvgAge} strokeWidth={2} name="High Priority" />
                                        <Line type="monotone" dataKey="mediumAvgAge" stroke={ageConfig.colors.mediumAvgAge} strokeWidth={2} name="Medium Priority" />
                                        <Line type="monotone" dataKey="lowAvgAge" stroke={ageConfig.colors.lowAvgAge} strokeWidth={2} name="Low Priority" />
                                    </LineChart>
                                </ResponsiveContainer>
                            </div>
                        )}
                        
                        {/* Incoming vs Outgoing Rate Analysis */}
                        <div className="mt-6">
                            <h4 className="font-medium mb-3">Incoming vs Outgoing Ticket Rate</h4>
                            <ResponsiveContainer width="100%" height={300}>
                                <LineChart data={(() => {
                                    // Calculate incoming vs outgoing rates by date for selected time period
                                    const dateMap = {};
                                    const today = new Date();
                                    
                                    // Calculate number of days based on time period selection
                                    const days = timePeriod === 'custom' ? customDays : parseInt(timePeriod.replace('d', ''));
                                    
                                    // Initialize selected time period with zero values
                                    for (let i = days - 1; i >= 0; i--) {
                                        const date = new Date(today);
                                        date.setDate(today.getDate() - i);
                                        const dateStr = date.toISOString().split('T')[0];
                                        dateMap[dateStr] = {
                                            date: dateStr,
                                            incoming: 0,
                                            outgoing: 0,
                                            net: 0
                                        };
                                    }
                                    
                                    // Count incoming tickets using pre-calculated flags
                                    if (realData.historicalTrend) {
                                        realData.historicalTrend.forEach(dayData => {
                                            if (dayData.tickets) {
                                                dayData.tickets.forEach(ticket => {
                                                    if (ticket.isIncoming && ticket.incomingDate) {
                                                        const incomingDate = ticket.incomingDate.split('T')[0];
                                                        if (dateMap[incomingDate]) {
                                                            dateMap[incomingDate].incoming++;
                                                        }
                                                    }
                                                });
                                            }
                                        });
                                    }
                                    
                                    // Count outgoing tickets using pre-calculated flags
                                    if (realData.historicalTrend) {
                                        realData.historicalTrend.forEach(dayData => {
                                            if (dayData.tickets) {
                                                dayData.tickets.forEach(ticket => {
                                                    if (ticket.isOutgoing && ticket.outgoingDate) {
                                                        const outgoingDate = ticket.outgoingDate.split('T')[0];
                                                        if (dateMap[outgoingDate]) {
                                                            dateMap[outgoingDate].outgoing++;
                                                        }
                                                    }
                                                });
                                            }
                                        });
                                    }
                                    
                                    // Calculate net flow and format for chart
                                    return Object.values(dateMap).map(day => ({
                                        ...day,
                                        net: day.incoming - day.outgoing,
                                        displayDate: new Date(day.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                                    }));
                                })()}>
                                    <CartesianGrid strokeDasharray="3 3" />
                                    <XAxis 
                                        dataKey="displayDate" 
                                        tick={{ fontSize: 10 }}
                                        angle={-45}
                                        textAnchor="end"
                                        height={60}
                                    />
                                    <YAxis label={{ value: 'Tickets', angle: -90, position: 'insideLeft' }} />
                                    <Tooltip 
                                        content={({ active, payload, label }) => {
                                            if (active && payload && payload.length) {
                                                const data = payload[0].payload;
                                                return (
                                                    <div className="bg-white p-3 border border-gray-300 rounded shadow">
                                                        <p className="font-semibold">{label}</p>
                                                        <p className="text-green-600">Incoming (PL Assigned): {data.incoming}</p>
                                                        <p className="text-red-600">Outgoing (PL > 99): {data.outgoing}</p>
                                                        <p className={`font-semibold ${data.net >= 0 ? 'text-blue-600' : 'text-orange-600'}`}>
                                                            Net: {data.net >= 0 ? '+' : ''}{data.net}
                                                        </p>
                                                    </div>
                                                );
                                            }
                                            return null;
                                        }}
                                    />
                                    <Legend />
                                    <Line 
                                        type="monotone" 
                                        dataKey="incoming" 
                                        stroke="#22c55e" 
                                        strokeWidth={2}
                                        name="Incoming (PL Assigned)" 
                                        dot={{ fill: '#22c55e', strokeWidth: 2, r: 3 }}
                                    />
                                    <Line 
                                        type="monotone" 
                                        dataKey="outgoing" 
                                        stroke="#ef4444" 
                                        strokeWidth={2}
                                        name="Outgoing (PL > 99)" 
                                        dot={{ fill: '#ef4444', strokeWidth: 2, r: 3 }}
                                    />
                                    <Line 
                                        type="monotone" 
                                        dataKey="net" 
                                        stroke="#3b82f6" 
                                        strokeWidth={2}
                                        strokeDasharray="5 5"
                                        name="Net Flow" 
                                        dot={{ fill: '#3b82f6', strokeWidth: 2, r: 3 }}
                                    />
                                </LineChart>
                            </ResponsiveContainer>
                            
                            {/* Summary Statistics */}
                            <div className="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                                {(() => {
                                    // Calculate number of days based on current time period selection
                                    const days = timePeriod === 'custom' ? customDays : parseInt(timePeriod.replace('d', ''));
                                    
                                    const currentPeriodStats = (() => {
                                        let totalIncoming = 0;
                                        let totalOutgoing = 0;
                                        const today = new Date();
                                        
                                        // Create date range for the selected period
                                        const periodDates = new Set();
                                        for (let i = days - 1; i >= 0; i--) {
                                            const date = new Date(today);
                                            date.setDate(today.getDate() - i);
                                            const dateStr = date.toISOString().split('T')[0];
                                            periodDates.add(dateStr);
                                        }
                                        
                                        // Count incoming tickets using pre-calculated flags (same as chart)
                                        if (realData.historicalTrend) {
                                            realData.historicalTrend.forEach(dayData => {
                                                if (dayData.tickets) {
                                                    dayData.tickets.forEach(ticket => {
                                                        if (ticket.isIncoming && ticket.incomingDate) {
                                                            const incomingDate = ticket.incomingDate.split('T')[0];
                                                            if (periodDates.has(incomingDate)) {
                                                                totalIncoming++;
                                                            }
                                                        }
                                                        
                                                        if (ticket.isOutgoing && ticket.outgoingDate) {
                                                            const outgoingDate = ticket.outgoingDate.split('T')[0];
                                                            if (periodDates.has(outgoingDate)) {
                                                                totalOutgoing++;
                                                            }
                                                        }
                                                    });
                                                }
                                            });
                                        }
                                        
                                        return { totalIncoming, totalOutgoing };
                                    })();
                                    
                                    const netFlow = currentPeriodStats.totalIncoming - currentPeriodStats.totalOutgoing;
                                    const avgDaily = {
                                        incoming: (currentPeriodStats.totalIncoming / days).toFixed(1),
                                        outgoing: (currentPeriodStats.totalOutgoing / days).toFixed(1),
                                        net: (netFlow / days).toFixed(1)
                                    };
                                    
                                    return (
                                        <>
                                            <div className="bg-green-50 p-3 rounded-lg text-center">
                                                <div className="text-2xl font-bold text-green-600">{currentPeriodStats.totalIncoming}</div>
                                                <div className="text-sm text-green-700">Total Incoming</div>
                                                <div className="text-xs text-green-600">{avgDaily.incoming}/day avg</div>
                                            </div>
                                            <div className="bg-red-50 p-3 rounded-lg text-center">
                                                <div className="text-2xl font-bold text-red-600">{currentPeriodStats.totalOutgoing}</div>
                                                <div className="text-sm text-red-700">Total Outgoing</div>
                                                <div className="text-xs text-red-600">{avgDaily.outgoing}/day avg</div>
                                            </div>
                                            <div className={`p-3 rounded-lg text-center ${netFlow >= 0 ? 'bg-blue-50' : 'bg-orange-50'}`}>
                                                <div className={`text-2xl font-bold ${netFlow >= 0 ? 'text-blue-600' : 'text-orange-600'}`}>
                                                    {netFlow >= 0 ? '+' : ''}{netFlow}
                                                </div>
                                                <div className={`text-sm ${netFlow >= 0 ? 'text-blue-700' : 'text-orange-700'}`}>Net Flow</div>
                                                <div className={`text-xs ${netFlow >= 0 ? 'text-blue-600' : 'text-orange-600'}`}>
                                                    {avgDaily.net >= 0 ? '+' : ''}{avgDaily.net}/day avg
                                                </div>
                                            </div>
                                            <div className="bg-gray-50 p-3 rounded-lg text-center">
                                                <div className="text-2xl font-bold text-gray-600">
                                                    {currentPeriodStats.totalOutgoing > 0 ? ((currentPeriodStats.totalIncoming / currentPeriodStats.totalOutgoing) * 100).toFixed(0) : '∞'}%
                                                </div>
                                                <div className="text-sm text-gray-700">In/Out Ratio</div>
                                                <div className="text-xs text-gray-600">
                                                    {currentPeriodStats.totalOutgoing > 0 ? 
                                                        (currentPeriodStats.totalIncoming / currentPeriodStats.totalOutgoing > 1 ? 'Growing' : 'Shrinking') : 
                                                        'No outgoing'
                                                    }
                                                </div>
                                            </div>
                                        </>
                                    );
                                })()}
                            </div>
                        </div>
                        
                    </div>
                    
                    <div className="mt-6">
                        <h4 className="font-medium mb-3">Source Label Summary</h4>
                        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-3">
                            {realData.sourceLabels?.map((source, index) => (
                                <div key={index} className="p-3 bg-gray-50 rounded-lg text-center">
                                    <div 
                                        className="w-4 h-4 rounded mx-auto mb-2" 
                                        style={{ backgroundColor: source.color }}
                                    ></div>
                                    <div className="font-medium text-sm">{source.name}</div>
                                    <div className="font-bold text-lg">{source.count}</div>
                                    <div className="text-xs text-gray-500">{source.percentage}%</div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };
        
        const TicketsPanel = ({ realData, jiraConfig }) => {
            if (!realData || !realData.tickets) return null;
            
            return (
                <div className="chart-container p-6">
                    <h3 className="text-lg font-semibold mb-4">Recent Tickets from {jiraConfig.project}</h3>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead>
                                <tr className="border-b">
                                    <th className="text-left py-2">Key</th>
                                    <th className="text-left py-2">Summary</th>
                                    <th className="text-left py-2">Current Status</th>
                                    <th className="text-left py-2">Current PL</th>
                                    <th className="text-left py-2">Age (Days)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {realData.tickets.slice(0, 10).map((ticket, index) => (
                                    <tr key={index} className="border-b hover:bg-gray-50">
                                        <td className="py-2 font-medium">
                                            <a 
                                                href={`${jiraConfig.baseUrl}/browse/${ticket.key}`} 
                                                target="_blank" 
                                                rel="noopener noreferrer"
                                                className="text-blue-600 hover:text-blue-800 hover:underline"
                                            >
                                                {ticket.key}
                                            </a>
                                        </td>
                                        <td className="py-2 max-w-xs truncate" title={ticket.summary}>{ticket.summary}</td>
                                        <td className="py-2">
                                            <div className="flex flex-col">
                                                <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs mb-1">
                                                    {ticket.currentStatus?.value || ticket.status}
                                                </span>
                                                {ticket.currentStatus?.lastChangedBy && (
                                                    <span className="text-xs text-gray-500">
                                                        by {ticket.currentStatus.lastChangedBy}
                                                    </span>
                                                )}
                                            </div>
                                        </td>
                                        <td className="py-2">
                                            <div className="flex flex-col">
                                                <span className={`px-2 py-1 rounded text-xs mb-1 ${
                                                    (ticket.currentPriorityLevel?.value || ticket.priorityLevel) < 10 
                                                        ? 'bg-red-100 text-red-800' 
                                                        : (ticket.currentPriorityLevel?.value || ticket.priorityLevel) < 100 
                                                        ? 'bg-yellow-100 text-yellow-800'
                                                        : 'bg-blue-100 text-blue-800'
                                                }`}>
                                                    {ticket.currentPriorityLevel?.value || ticket.priorityLevel || 'N/A'}
                                                </span>
                                                {ticket.currentPriorityLevel?.lastChangedBy && (
                                                    <span className="text-xs text-gray-500">
                                                        by {ticket.currentPriorityLevel.lastChangedBy}
                                                    </span>
                                                )}
                                            </div>
                                        </td>
                                        <td className="py-2">{ticket.ageInDays}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };
        
        
        // Custom Tooltip Components (used by charts)
        const CustomTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                return (
                    <div className="bg-white p-3 border border-gray-300 rounded-lg shadow-lg">
                        <p className="font-semibold mb-2">{`Date: ${label}`}</p>
                        {payload.map((entry, index) => (
                            <div key={index} className="flex items-center mb-1">
                                <div 
                                    className="w-3 h-3 rounded mr-2" 
                                    style={{ backgroundColor: entry.color }}
                                ></div>
                                <span className="text-sm">{entry.name}: {entry.value} labels</span>
                            </div>
                        ))}
                    </div>
                );
            }
            return null;
        };

        const SourceLabelsTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                return (
                    <div className="bg-white p-3 border border-gray-300 rounded-lg shadow-lg max-w-md">
                        <p className="font-semibold mb-2">{`Date: ${label}`}</p>
                        {payload.map((entry, index) => {
                            if (entry.value > 0) {
                                // Find the corresponding ticket keys from the payload data
                                const ticketKeysField = `${entry.dataKey}_tickets`;
                                const ticketKeys = entry.payload[ticketKeysField] || [];
                                
                                return (
                                    <div key={index} className="mb-2">
                                        <div className="flex items-center mb-1">
                                            <div 
                                                className="w-3 h-3 rounded mr-2" 
                                                style={{ backgroundColor: entry.color }}
                                            ></div>
                                            <span className="text-sm font-medium">{entry.name}: {entry.value} tickets</span>
                                        </div>
                                        {ticketKeys.length > 0 && (
                                            <div className="ml-5 text-xs text-gray-600">
                                                <span className="font-medium">Tickets: </span>
                                                {ticketKeys.map((key, keyIndex) => (
                                                    <span key={keyIndex}>
                                                        <a 
                                                            href={`https://komutel.atlassian.net/browse/${key}`}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            className="text-blue-600 hover:text-blue-800 underline"
                                                        >
                                                            {key}
                                                        </a>
                                                        {keyIndex < ticketKeys.length - 1 ? ', ' : ''}
                                                    </span>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                );
                            }
                            return null;
                        }).filter(Boolean)}
                    </div>
                );
            }
            return null;
        };

        const CustomAgeTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                return (
                    <div className="bg-white p-3 border border-gray-300 rounded-lg shadow-lg">
                        <p className="font-semibold mb-2">{`Date: ${label}`}</p>
                        {payload.map((entry, index) => (
                            <div key={index} className="flex items-center mb-1">
                                <div 
                                    className="w-3 h-3 rounded mr-2" 
                                    style={{ backgroundColor: entry.color }}
                                ></div>
                                <span className="text-sm">{entry.name}: {entry.value} days avg</span>
                            </div>
                        ))}
                    </div>
                );
            }
            return null;
        };

        // Dynamic Dashboard Renderer
        const DashboardRenderer = ({ sections, realData, jiraConfig, timePeriod, customDays, timeInterval }) => {
            const renderSection = (section) => {
                if (!section.enabled) return null;
                
                const commonProps = { realData, jiraConfig, timePeriod, customDays, timeInterval };
                
                switch(section.component) {
                    case 'OverviewPanel':
                        return <OverviewPanel key={section.id} {...commonProps} />;
                    case 'TrendsPanel':
                        return <TrendsPanel key={section.id} {...commonProps} />;
                    case 'SourcesPanel':
                        return <SourcesPanel key={section.id} {...commonProps} />;
                    case 'TicketsPanel':
                        return <TicketsPanel key={section.id} {...commonProps} />;
                    default:
                        return null;
                }
            };
            
            return (
                <div className="space-y-6">
                    {sections.map(renderSection)}
                </div>
            );
        };

        // Main Application Component
        const JiraAnalyticsApp = () => {
            const [loading, setLoading] = useState(false);
            const [connectionStatus, setConnectionStatus] = useState('disconnected');
            const [lastSync, setLastSync] = useState(null);
            const [realData, setRealData] = useState(null);
            const [error, setError] = useState(null);
            const [showConfig, setShowConfig] = useState(false);
            const [isProductionMode, setIsProductionMode] = useState(false);
            const [cacheStatus, setCacheStatus] = useState(null);
            
            // Testing enhancements
            const [currentScenario, setCurrentScenario] = useState('normal');
            const [showDevPanel, setShowDevPanel] = useState(false);
            const [showLogs, setShowLogs] = useState(false);
            
            // Log component initialization
            useEffect(() => {
                try {
                    Logger.debug('INIT', 'JiraAnalyticsApp component mounted', {
                        chartsAvailable: ChartsAvailable,
                        reactVersion: React.version,
                        userAgent: navigator.userAgent,
                        viewport: { width: window.innerWidth, height: window.innerHeight }
                    });
                    Logger.state('APP', { isProductionMode, currentScenario }, 'INIT');
                } catch (error) {
                    console.error('Error in init useEffect:', error);
                }
            }, []);
            
            // Log state changes
            useEffect(() => {
                try {
                    Logger.state('APP', { loading, connectionStatus, error: !!error }, 'STATE_UPDATE');
                } catch (error) {
                    console.error('Error in state logging useEffect:', error);
                }
            }, [loading, connectionStatus, error]);
            
            useEffect(() => {
                try {
                    Logger.debug('SCENARIO', `Switched to scenario: ${currentScenario}`, TEST_SCENARIOS[currentScenario]);
                } catch (error) {
                    console.error('Error in scenario logging useEffect:', error);
                }
            }, [currentScenario]);

            // Load saved config from localStorage
            const loadSavedConfig = () => {
                try {
                    const saved = localStorage.getItem('jiraConfig');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        return {
                            baseUrl: parsed.baseUrl || 'https://komutel.atlassian.net',
                            email: parsed.email || 'robert.mohid@versaterm.com',
                            apiToken: parsed.apiToken || '',
                            project: parsed.project || 'KSD',
                            jqlQuery: parsed.jqlQuery || 'project = KSD AND cf[11129] > 0 AND created >= -30d ORDER BY created DESC'
                        };
                    }
                } catch (e) {
                    console.error('Error loading saved config:', e);
                }
                return {
                    baseUrl: 'https://komutel.atlassian.net',
                    email: 'robert.mohid@versaterm.com',
                    apiToken: '',
                    project: 'KSD',
                    jqlQuery: 'project = KSD AND cf[11129] > 0 AND created >= -30d ORDER BY created DESC'
                };
            };

            // Jira configuration
            const [jiraConfig, setJiraConfig] = useState(loadSavedConfig());

            // Time period and interval settings
            const [timePeriod, setTimePeriod] = useState('30d'); // 7d, 30d, 90d, 180d, 365d, custom
            const [timeInterval, setTimeInterval] = useState('daily'); // daily, weekly, monthly
            const [customDays, setCustomDays] = useState(30);

            // Production API calls (would connect to real backend)
            const productionJiraAPI = async (endpoint, data = {}) => {
                try {
                    const response = await fetch(`http://localhost:3001/api/jira/${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Backend API error: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (err) {
                    throw new Error('Backend not available. Run server.js first or switch to Demo mode.');
                }
            };

            // Demo data simulation with test scenarios
            const simulateJiraAPI = async (endpoint, data = {}) => {
                const startTime = performance.now();
                Logger.debug('API', `Simulating ${endpoint} call`, { endpoint, data, scenario: currentScenario });
                
                // Check if we're in a special test scenario
                const scenario = TEST_SCENARIOS[currentScenario];
                
                // Handle error scenarios
                if (scenario.error) {
                    Logger.error('API', `Scenario error: ${scenario.error}`);
                    throw new Error(scenario.error);
                }
                
                // Handle loading scenarios
                if (scenario.loading) {
                    Logger.debug('API', 'Simulating long loading state');
                    await new Promise(resolve => setTimeout(resolve, 5000)); // 5 second delay
                }
                
                // Simulate network delay based on scenario
                const baseDelay = currentScenario === 'highActivity' ? 2000 : 
                                currentScenario === 'lowActivity' ? 500 : 1000;
                const randomDelay = Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, baseDelay + randomDelay));
                
                // Occasional random network errors (except in controlled scenarios)
                if (!scenario.error && !scenario.loading && Math.random() < 0.02) {
                    const errorMsg = 'Simulated network timeout - please try again';
                    Logger.error('API', errorMsg);
                    throw new Error(errorMsg);
                }


                if (endpoint === 'current-tickets') {
                    const endTime = performance.now();
                    Logger.performance('current-tickets API', endTime - startTime);
                    
                    // Use scenario data if available
                    if (scenario.currentCounts && scenario.tickets) {
                        Logger.debug('API', 'Using scenario data for current-tickets', { 
                            counts: scenario.currentCounts, 
                            ticketCount: scenario.tickets.length 
                        });
                        return {
                            counts: scenario.currentCounts,
                            tickets: scenario.tickets
                        };
                    }
                    
                    // Fallback to generated data for normal scenario
                    const generateTickets = (count, priorityCategory, priorityRange) => {
                        const tickets = [];
                        const statuses = ['Open', 'In Progress', 'Code Review', 'Testing', 'Blocked'];
                        const summaries = [
                            'Database performance optimization needed',
                            'User authentication system enhancement',
                            'API rate limiting implementation',
                            'Frontend responsive design fixes',
                            'Memory leak investigation in production',
                            'Integration test automation setup',
                            'Security vulnerability assessment',
                            'Third-party library version updates',
                            'Error handling improvement in checkout',
                            'Load balancer configuration review'
                        ];

                        for (let i = 0; i < count; i++) {
                            const priority = priorityRange[0] + Math.floor(Math.random() * (priorityRange[1] - priorityRange[0]));
                            const daysAgo = Math.floor(Math.random() * 90);
                            const createdDate = new Date();
                            createdDate.setDate(createdDate.getDate() - daysAgo);

                            tickets.push({
                                key: `KSD-${1000 + Math.floor(Math.random() * 9000)}`,
                                summary: summaries[Math.floor(Math.random() * summaries.length)],
                                status: statuses[Math.floor(Math.random() * statuses.length)],
                                created: createdDate.toISOString(),
                                priorityLevel: priority,
                                priorityCategory: priorityCategory,
                                ageInDays: daysAgo
                            });
                        }
                        return tickets;
                    };

                    const highTickets = generateTickets(8, 'high', [1, 9]);
                    const mediumTickets = generateTickets(23, 'medium', [10, 99]);
                    const lowTickets = generateTickets(67, 'low', [100, 500]);
                    const allTickets = [...highTickets, ...mediumTickets, ...lowTickets];

                    return {
                        counts: {
                            high: highTickets.length,
                            medium: mediumTickets.length,
                            low: lowTickets.length,
                            total: allTickets.length
                        },
                        tickets: allTickets.sort((a, b) => new Date(b.created) - new Date(a.created))
                    };
                }

                if (endpoint === 'historical-data') {
                    // Extract source labels dynamically from ticket data
                    const extractSourceLabels = (tickets) => {
                        const labelCounts = {};
                        const labelColors = {
                            'src-bug-fix': '#22c55e',
                            'src-golive-critical': '#ef4444',
                            'src-new-feature': '#3b82f6',
                            'src-integration': '#a855f7',
                            'src-tech-debt': '#f59e0b',
                            'src-unknown': '#6b7280',
                            'src-maintenance': '#06b6d4',
                            'src-enhancement': '#ec4899',
                            'src-research': '#84cc16',
                            'src-critical': '#dc2626',
                            'src-security': '#8b5cf6',
                            'src-performance': '#14b8a6',
                            'src-refactor': '#f97316',
                            'src-documentation': '#10b981',
                            'src-testing': '#eab308',
                            'src-deployment': '#1d4ed8',
                            'src-config': '#7c2d12',
                            'src-hotfix': '#991b1b',
                            'src-release': '#059669',
                            'src-migration': '#c2410c'
                        };
                        
                        // Default color palette for new labels
                        const defaultColors = [
                            '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6',
                            '#14b8a6', '#f97316', '#06b6d4', '#ec4899', '#84cc16',
                            '#6366f1', '#a855f7', '#22c55e', '#fb923c', '#0ea5e9'
                        ];
                        let colorIndex = 0;
                        
                        // Count labels from tickets
                        tickets.forEach(ticket => {
                            if (ticket.labels && Array.isArray(ticket.labels)) {
                                ticket.labels.forEach(label => {
                                    if (label.startsWith('src-')) {
                                        labelCounts[label] = (labelCounts[label] || 0) + 1;
                                    }
                                });
                            }
                        });
                        
                        // Convert to array and calculate percentages
                        const total = Object.values(labelCounts).reduce((sum, count) => sum + count, 0);
                        const sourceLabels = Object.entries(labelCounts)
                            .map(([label, count]) => {
                                let color = labelColors[label];
                                if (!color) {
                                    color = defaultColors[colorIndex % defaultColors.length];
                                    colorIndex++;
                                }
                                
                                const name = label.replace('src-', '')
                                    .split('-')
                                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                                    .join(' ');
                                
                                return {
                                    name,
                                    label,
                                    count,
                                    percentage: total > 0 ? Math.round((count / total) * 100) : 0,
                                    color
                                };
                            })
                            .sort((a, b) => b.count - a.count);
                        
                        // If no labels found, use default set
                        if (sourceLabels.length === 0) {
                            Logger.debug('LABELS', 'No source labels found in tickets, using defaults');
                            return DASHBOARD_CONFIG.labels.sourceLabels;
                        }
                        
                        Logger.debug('LABELS', `Extracted ${sourceLabels.length} source labels from ${tickets.length} tickets`, sourceLabels);
                        return sourceLabels;
                    };
                    
                    // Get tickets for label extraction
                    let ticketsForLabels = [];
                    if (scenario.tickets && Array.isArray(scenario.tickets)) {
                        ticketsForLabels = scenario.tickets;
                    } else {
                        // Generate sample tickets with labels for demo
                        const labels = ['src-bug-fix', 'src-new-feature', 'src-tech-debt', 'src-security', 
                                      'src-performance', 'src-refactor', 'src-documentation', 'src-testing',
                                      'src-deployment', 'src-hotfix', 'src-maintenance', 'src-enhancement'];
                        
                        ticketsForLabels = Array.from({ length: 50 }, (_, i) => ({
                            key: `DEMO-${i + 1}`,
                            labels: [labels[Math.floor(Math.random() * labels.length)], 
                                    Math.random() > 0.5 ? labels[Math.floor(Math.random() * labels.length)] : null]
                                    .filter(Boolean)
                        }));
                    }
                    
                    // Extract labels from tickets
                    const extractedLabels = extractSourceLabels(ticketsForLabels);
                    
                    // Generate time series data based on time period and interval
                    const generateTimeSeries = () => {
                        const series = [];
                        const days = data.timePeriod === 'custom' ? data.customDays : parseInt(data.timePeriod.replace('d', ''));
                        const interval = data.timeInterval || 'daily';
                        
                        let step = 1;
                        if (interval === 'weekly') step = 7;
                        if (interval === 'monthly') step = 30;
                        
                        for (let i = 0; i <= days; i += step) {
                            const date = new Date();
                            date.setDate(date.getDate() - (days - i));
                            
                            const baseHigh = Math.max(1, 12 - Math.floor(i / 5) + Math.floor(Math.random() * 4) - 2);
                            const baseMedium = Math.max(1, 25 - Math.floor(i / 8) + Math.floor(Math.random() * 8) - 4);
                            const baseLow = Math.max(1, 65 - Math.floor(i / 10) + Math.floor(Math.random() * 12) - 6);

                            series.push({
                                date: date.toISOString().split('T')[0],
                                high: baseHigh * (interval === 'weekly' ? 7 : interval === 'monthly' ? 30 : 1),
                                medium: baseMedium * (interval === 'weekly' ? 7 : interval === 'monthly' ? 30 : 1),
                                low: baseLow * (interval === 'weekly' ? 7 : interval === 'monthly' ? 30 : 1),
                                total: (baseHigh + baseMedium + baseLow) * (interval === 'weekly' ? 7 : interval === 'monthly' ? 30 : 1)
                            });
                        }
                        return series;
                    };

                    // Generate source labels time series
                    const generateSourceTimeSeries = () => {
                        const series = [];
                        const days = data.timePeriod === 'custom' ? data.customDays : parseInt(data.timePeriod.replace('d', ''));
                        const interval = data.timeInterval || 'daily';
                        
                        let step = 1;
                        if (interval === 'weekly') step = 7;
                        if (interval === 'monthly') step = 30;
                        
                        for (let i = 0; i <= days; i += step) {
                            const date = new Date();
                            date.setDate(date.getDate() - (days - i));
                            
                            const dayOffset = i / days;
                            const mult = interval === 'weekly' ? 7 : interval === 'monthly' ? 30 : 1;
                            
                            const sourceData = {
                                date: date.toISOString().split('T')[0]
                            };
                            
                            // Generate data for all extracted labels
                            extractedLabels.forEach((labelInfo, index) => {
                                const baseValue = Math.max(1, 10 - index); // Higher count labels get higher base values
                                const variation = Math.sin((dayOffset + index * 0.1) * Math.PI * 2) * (baseValue / 2);
                                const randomness = Math.floor(Math.random() * 3);
                                const count = Math.max(0, Math.floor((baseValue + variation + randomness) * mult));
                                sourceData[labelInfo.label] = count;
                                
                                // Generate realistic ticket keys for this source label and time period
                                const ticketKeys = [];
                                for (let j = 0; j < count; j++) {
                                    // Create unique ticket keys based on date and label index
                                    const dateHash = sourceData.date.replace(/-/g, '');
                                    const ticketNumber = 1000 + (index * 100) + (i * 10) + j + 1;
                                    ticketKeys.push(`KSD-${ticketNumber}`);
                                }
                                sourceData[`${labelInfo.label}_tickets`] = ticketKeys;
                            });
                            
                            series.push(sourceData);
                        }
                        return series;
                    };

                    // Generate average age time series
                    const generateAverageAgeTimeSeries = () => {
                        const series = [];
                        const days = data.timePeriod === 'custom' ? data.customDays : parseInt(data.timePeriod.replace('d', ''));
                        const interval = data.timeInterval || 'daily';
                        
                        let step = 1;
                        if (interval === 'weekly') step = 7;
                        if (interval === 'monthly') step = 30;
                        
                        for (let i = 0; i <= days; i += step) {
                            const date = new Date();
                            date.setDate(date.getDate() - (days - i));
                            
                            const dayOffset = i / days;
                            
                            series.push({
                                date: date.toISOString().split('T')[0],
                                highAvgAge: Math.max(5, 15 + Math.floor(dayOffset * 8) + Math.floor(Math.sin(dayOffset * Math.PI * 2) * 5) + Math.floor(Math.random() * 6) - 3),
                                mediumAvgAge: Math.max(10, 35 + Math.floor(dayOffset * 12) + Math.floor(Math.cos(dayOffset * Math.PI * 1.5) * 8) + Math.floor(Math.random() * 10) - 5),
                                lowAvgAge: Math.max(20, 55 + Math.floor(dayOffset * 20) + Math.floor(Math.sin(dayOffset * Math.PI * 0.8) * 10) + Math.floor(Math.random() * 15) - 7)
                            });
                        }
                        return series;
                    };

                    return {
                        timeSeries: generateTimeSeries(),
                        sourceLabelsTimeSeries: generateSourceTimeSeries(),
                        averageAgeTimeSeries: generateAverageAgeTimeSeries(),
                        sourceLabels: extractedLabels
                    };
                }

                throw new Error('Unknown endpoint');
            };

            // API client selector
            const jiraAPI = isProductionMode ? productionJiraAPI : simulateJiraAPI;

            // Helper function to generate JQL query based on time period
            const generateJQL = () => {
                const days = timePeriod === 'custom' ? customDays : timePeriod.replace('d', '');
                return `project = ${jiraConfig.project} AND cf[11129] > 0 AND created >= -${days}d ORDER BY created DESC`;
            };

            // Update JQL when time period changes
            useEffect(() => {
                const newJQL = generateJQL();
                setJiraConfig(prev => ({ ...prev, jqlQuery: newJQL }));
            }, [timePeriod, customDays, jiraConfig.project]);


            // Fetch data
            const fetchData = async () => {
                if (!jiraConfig.apiToken && isProductionMode) {
                    setError('API Token is required for production mode');
                    return;
                }

                setLoading(true);
                setError(null);

                try {
                    const [currentData, historicalData] = await Promise.all([
                        jiraAPI('current-tickets', { ...jiraConfig, timePeriod, timeInterval }),
                        jiraAPI('historical-data', { ...jiraConfig, timePeriod, timeInterval })
                    ]);

                    setRealData({
                        currentCounts: currentData.counts,
                        tickets: currentData.tickets,
                        historicalTrend: historicalData.timeSeries,
                        sourceLabelsTimeSeries: historicalData.sourceLabelsTimeSeries,
                        averageAgeTimeSeries: historicalData.averageAgeTimeSeries,
                        sourceLabels: historicalData.sourceLabels,
                        lastUpdated: new Date().toISOString()
                    });

                    setConnectionStatus('connected');
                    setLastSync(new Date().toISOString());

                } catch (err) {
                    setError(err.message);
                    setConnectionStatus('error');
                } finally {
                    setLoading(false);
                }
            };

            // Auto-fetch in demo mode
            useEffect(() => {
                try {
                    if (!isProductionMode) {
                        Logger.debug('AUTO-FETCH', 'Auto-fetching demo data');
                        fetchData();
                    }
                } catch (error) {
                    console.error('Error in auto-fetch useEffect:', error);
                    Logger.error('AUTO-FETCH', 'Failed to auto-fetch', error);
                }
            }, [isProductionMode]); // Removed fetchData dependency to prevent infinite loop

            // Auto-refresh when time period or interval changes
            useEffect(() => {
                try {
                    // Only refresh if we have data and are in a connected state
                    if (realData && (connectionStatus === 'connected' || !isProductionMode)) {
                        Logger.debug('AUTO-REFRESH', 'Auto-refreshing data due to parameter change');
                        fetchData();
                    }
                } catch (error) {
                    console.error('Error in auto-refresh useEffect:', error);
                    Logger.error('AUTO-REFRESH', 'Failed to auto-refresh', error);
                }
            }, [timePeriod, timeInterval, customDays]); // Simplified dependencies

            // Save config to localStorage whenever it changes
            useEffect(() => {
                try {
                    localStorage.setItem('jiraConfig', JSON.stringify(jiraConfig));
                } catch (e) {
                    console.error('Error saving config:', e);
                }
            }, [jiraConfig]);


            const ConnectionStatus = () => {
                const getStatusConfig = () => {
                    switch(connectionStatus) {
                        case 'connected':
                            return {
                                color: 'text-green-600',
                                icon: <CheckIcon />,
                                text: isProductionMode ? 'Connected to Jira' : 'Demo Mode Active'
                            };
                        case 'error':
                            return {
                                color: 'text-red-600',
                                icon: <XIcon />,
                                text: 'Connection Error'
                            };
                        default:
                            return {
                                color: 'text-gray-600',
                                icon: <ClockIcon />,
                                text: 'Not Connected'
                            };
                    }
                };

                const { color, icon, text } = getStatusConfig();

                return (
                    <div className={`flex items-center ${color} text-sm`}>
                        {icon}
                        <span className="ml-2">{text}</span>
                        {lastSync && (
                            <span className="ml-2 text-gray-500">
                                (Last sync: {new Date(lastSync).toLocaleTimeString()})
                            </span>
                        )}
                    </div>
                );
            };

            // Add early return for debugging
            if (!ChartsAvailable) {
                Logger.debug('CHARTS', 'Charts not available, showing fallback');
            }

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-7xl mx-auto space-y-6">
                        
                        {/* Header */}
                        <div className="bg-white shadow-sm border border-gray-200 rounded-lg p-6">
                            <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
                                <div className="flex items-center">
                                    <DatabaseIcon />
                                    <div className="ml-3">
                                        <h1 className="text-2xl font-bold text-gray-900">Jira Analytics Dashboard</h1>
                                        <ConnectionStatus />
                                    </div>
                                </div>
                                
                                <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                                    {/* Mode Toggle */}
                                    <div className="flex items-center space-x-3 px-4 py-2 bg-gray-100 rounded-lg">
                                        <span className={`text-sm font-medium ${!isProductionMode ? 'text-blue-600' : 'text-gray-500'}`}>
                                            Demo
                                        </span>
                                        <label className="toggle-switch">
                                            <input 
                                                type="checkbox" 
                                                checked={isProductionMode}
                                                onChange={(e) => setIsProductionMode(e.target.checked)}
                                            />
                                            <span className="slider"></span>
                                        </label>
                                        <span className={`text-sm font-medium ${isProductionMode ? 'text-green-600' : 'text-gray-500'}`}>
                                            Production
                                        </span>
                                    </div>


                                    {/* Developer Tools */}
                                    <div className="flex items-center space-x-2">
                                        <button
                                            onClick={() => setShowDevPanel(!showDevPanel)}
                                            className="flex items-center px-3 py-2 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 text-sm"
                                            title="Toggle developer panel"
                                        >
                                            🔧 Dev
                                        </button>
                                        <button
                                            onClick={() => setShowLogs(!showLogs)}
                                            className="flex items-center px-3 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-sm"
                                            title="Toggle logs panel"
                                        >
                                            📋 Logs
                                        </button>
                                    </div>

                                    {/* Time Period Selector */}
                                    <div className="flex items-center space-x-2 px-4 py-2 bg-gray-100 rounded-lg">
                                        <span className="text-sm font-medium text-gray-700">Period:</span>
                                        <select
                                            value={timePeriod}
                                            onChange={(e) => setTimePeriod(e.target.value)}
                                            className="text-sm border border-gray-300 rounded px-2 py-1"
                                        >
                                            <option value="7d">Last 7 days</option>
                                            <option value="30d">Last 30 days</option>
                                            <option value="90d">Last 90 days</option>
                                            <option value="180d">Last 180 days</option>
                                            <option value="365d">Last year</option>
                                            <option value="custom">Custom</option>
                                        </select>
                                        {timePeriod === 'custom' && (
                                            <input
                                                type="number"
                                                value={customDays}
                                                onChange={(e) => setCustomDays(Math.max(1, parseInt(e.target.value) || 1))}
                                                className="w-16 text-sm border border-gray-300 rounded px-2 py-1"
                                                min="1"
                                                max="730"
                                            />
                                        )}
                                    </div>

                                    {/* Time Interval Selector */}
                                    <div className="flex items-center space-x-2 px-4 py-2 bg-gray-100 rounded-lg">
                                        <span className="text-sm font-medium text-gray-700">Interval:</span>
                                        <select
                                            value={timeInterval}
                                            onChange={(e) => setTimeInterval(e.target.value)}
                                            className="text-sm border border-gray-300 rounded px-2 py-1"
                                        >
                                            <option value="daily">Daily</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="monthly">Monthly</option>
                                        </select>
                                    </div>
                                    
                                    <button
                                        onClick={() => setShowConfig(!showConfig)}
                                        className="flex items-center px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"
                                    >
                                        <SettingsIcon />
                                        <span className="ml-2">{showConfig ? 'Hide Config' : 'Show Config'}</span>
                                    </button>
                                    
                                    <button
                                        onClick={fetchData}
                                        disabled={loading || (isProductionMode && !jiraConfig.apiToken)}
                                        className="flex items-center px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:bg-gray-300"
                                    >
                                        <RefreshIcon spinning={loading} />
                                        <span className="ml-2">{loading ? 'Fetching...' : 'Fetch Data'}</span>
                                    </button>
                                </div>
                            </div>

                            {/* Mode Information */}
                            <div className={`mt-4 p-3 rounded-lg border ${
                                isProductionMode 
                                    ? 'bg-green-50 border-green-200' 
                                    : 'bg-blue-50 border-blue-200'
                            }`}>
                                <div className="flex items-start">
                                    <DatabaseIcon />
                                    <div className={`ml-3 text-sm ${
                                        isProductionMode ? 'text-green-800' : 'text-blue-800'
                                    }`}>
                                        {isProductionMode ? (
                                            <>
                                                <p className="font-medium mb-1">Production Mode - Live Jira Connection</p>
                                                <p>Connected to real Jira API endpoints. Requires valid API token and backend server running on localhost:3001.</p>
                                            </>
                                        ) : (
                                            <>
                                                <p className="font-medium mb-1">Demo Mode - Simulated Data</p>
                                                <p>Using realistic simulated data for demonstration. No real Jira connection required.</p>
                                            </>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Configuration Panel */}
                            {showConfig && (
                                <div className="mt-6 p-4 bg-gray-50 rounded-lg border">
                                    <h3 className="text-lg font-semibold mb-4">Jira Connection Settings</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Jira Base URL</label>
                                            <input
                                                type="url"
                                                value={jiraConfig.baseUrl}
                                                onChange={(e) => setJiraConfig(prev => ({ ...prev, baseUrl: e.target.value }))}
                                                className="w-full border border-gray-300 rounded px-3 py-2"
                                                autoComplete="off"
                                                data-lpignore="true"
                                                data-form-type="other"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Email</label>
                                            <input
                                                type="email"
                                                value={jiraConfig.email}
                                                onChange={(e) => setJiraConfig(prev => ({ ...prev, email: e.target.value }))}
                                                className="w-full border border-gray-300 rounded px-3 py-2"
                                                autoComplete="off"
                                                data-lpignore="true"
                                                data-form-type="other"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">
                                                API Token
                                                {jiraConfig.apiToken && (
                                                    <span className="ml-2 text-xs text-green-600 font-normal">
                                                        (Saved locally)
                                                    </span>
                                                )}
                                            </label>
                                            <input
                                                type="password"
                                                value={jiraConfig.apiToken}
                                                onChange={(e) => setJiraConfig(prev => ({ ...prev, apiToken: e.target.value }))}
                                                className="w-full border border-gray-300 rounded px-3 py-2"
                                                placeholder={jiraConfig.apiToken ? "••••••••••••••••••••" : "Your Jira API token"}
                                                autoComplete="new-password"
                                                data-lpignore="true"
                                                data-form-type="other"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Project Key</label>
                                            <input
                                                type="text"
                                                value={jiraConfig.project}
                                                onChange={(e) => setJiraConfig(prev => ({ ...prev, project: e.target.value }))}
                                                className="w-full border border-gray-300 rounded px-3 py-2"
                                                autoComplete="off"
                                                data-lpignore="true"
                                                data-form-type="other"
                                            />
                                        </div>
                                    </div>
                                    
                                    {/* JQL Query Section */}
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium mb-2">JQL Query</label>
                                        <textarea
                                            value={jiraConfig.jqlQuery}
                                            onChange={(e) => setJiraConfig(prev => ({ ...prev, jqlQuery: e.target.value }))}
                                            className="w-full h-24 border border-gray-300 rounded px-3 py-2 font-mono text-sm"
                                            placeholder="project = KSD AND cf[11129] > 0 AND created >= -30d ORDER BY created DESC"
                                            autoComplete="off"
                                            data-lpignore="true"
                                            data-form-type="other"
                                        />
                                        <div className="mt-2 text-xs text-gray-600">
                                            <strong>Default Query:</strong> All KSD tickets with Priority Level > 0 created in last 30 days
                                        </div>
                                        <div className="mt-1 text-xs text-blue-600">
                                            <strong>Tips:</strong> Use cf[11129] for Priority Level field • Use -30d for last 30 days • Add ORDER BY for sorting
                                        </div>
                                    </div>

                                    {/* Quick JQL Templates */}
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium mb-2">Quick JQL Templates</label>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                            {[
                                                {
                                                    name: 'High Priority (PL < 10)',
                                                    query: () => `project = ${jiraConfig.project} AND cf[11129] < 10 AND status not in ("Done", "Closed") ORDER BY cf[11129] ASC`
                                                },
                                                {
                                                    name: 'Current Time Period',
                                                    query: () => generateJQL()
                                                },
                                                {
                                                    name: 'Source Label Analysis',
                                                    query: () => `project = ${jiraConfig.project} AND labels in ("src-bug-fix", "src-new-feature", "src-tech-debt") AND created >= -${timePeriod === 'custom' ? customDays : timePeriod.replace('d', '')}d`
                                                },
                                                {
                                                    name: 'All Active Tickets',
                                                    query: () => `project = ${jiraConfig.project} AND status not in ("Done", "Closed", "Resolved") ORDER BY cf[11129] ASC`
                                                }
                                            ].map((template, index) => (
                                                <button
                                                    key={index}
                                                    onClick={() => setJiraConfig(prev => ({ ...prev, jqlQuery: typeof template.query === 'function' ? template.query() : template.query }))}
                                                    className="text-left p-2 border border-gray-200 rounded hover:bg-blue-50 hover:border-blue-300"
                                                >
                                                    <div className="font-medium text-sm text-blue-700">{template.name}</div>
                                                    <div className="text-xs text-gray-500 font-mono truncate">{typeof template.query === 'function' ? template.query() : template.query}</div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {!jiraConfig.apiToken && isProductionMode && (
                                        <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-yellow-700">
                                            <strong>Production Mode Requires Setup:</strong> Get your API token from{' '}
                                            <a href="https://id.atlassian.com/manage-profile/security/api-tokens" 
                                               className="text-blue-600 underline" target="_blank" rel="noopener noreferrer">
                                                Atlassian Account Settings
                                            </a>
                                        </div>
                                    )}
                                    
                                    {jiraConfig.apiToken && (
                                        <div className="mt-4 flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded">
                                            <span className="text-green-700">
                                                <strong>API Token Saved:</strong> Your credentials are stored locally
                                            </span>
                                            <button
                                                onClick={() => {
                                                    if (confirm('Are you sure you want to clear your saved API token?')) {
                                                        setJiraConfig(prev => ({ ...prev, apiToken: '' }));
                                                    }
                                                }}
                                                className="text-sm px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600"
                                            >
                                                Clear Token
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}

                            {error && (
                                <div className="mt-4 p-3 bg-red-50 border border-red-200 rounded text-red-700">
                                    <strong>Error:</strong> {error}
                                </div>
                            )}

                        </div>

                        {/* Dynamic Dashboard Content */}
                        <DashboardRenderer 
                            sections={DASHBOARD_CONFIG.sections}
                            realData={realData}
                            jiraConfig={jiraConfig}
                            timePeriod={timePeriod}
                            customDays={customDays}
                            timeInterval={timeInterval}
                        />

                        {/* Legacy Current Status Cards - Remove after testing */}
                        {false && realData && (
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-red-600 text-sm font-medium">High Priority</p>
                                            <p className="text-3xl font-bold text-red-700">{realData.currentCounts?.high || 0}</p>
                                        </div>
                                        <AlertIcon />
                                    </div>
                                </div>
                                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-yellow-600 text-sm font-medium">Medium Priority</p>
                                            <p className="text-3xl font-bold text-yellow-700">{realData.currentCounts?.medium || 0}</p>
                                        </div>
                                        <TrendingIcon />
                                    </div>
                                </div>
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-blue-600 text-sm font-medium">Low Priority</p>
                                            <p className="text-3xl font-bold text-blue-700">{realData.currentCounts?.low || 0}</p>
                                        </div>
                                        <ClockIcon />
                                    </div>
                                </div>
                                <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-gray-600 text-sm font-medium">Total Active</p>
                                            <p className="text-3xl font-bold text-gray-700">{realData.currentCounts?.total || 0}</p>
                                        </div>
                                        <DatabaseIcon />
                                    </div>
                                </div>
                            </div>
                        )}


                        {/* No Data State */}
                        {!realData && !loading && (
                            <div className="chart-container p-12 text-center">
                                <DatabaseIcon />
                                <h3 className="text-lg font-medium text-gray-900 mb-2">No Data Loaded</h3>
                                <p className="text-gray-500 mb-6">
                                    {isProductionMode 
                                        ? (!jiraConfig.apiToken 
                                            ? 'Configure your Jira API token and click "Fetch Data" to load live ticket information.'
                                            : 'Click "Fetch Data" to load your Jira tickets and analytics.')
                                        : 'Click "Fetch Data" to load demo analytics data, or switch to Production mode for live Jira data.'
                                    }
                                </p>
                                <button
                                    onClick={fetchData}
                                    className="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600"
                                >
                                    {isProductionMode ? 'Load Live Data' : 'Load Demo Data'}
                                </button>
                            </div>
                        )}

                        {/* Developer Panel */}
                        {showDevPanel && (
                            <div className="fixed bottom-0 left-0 right-0 bg-purple-900 text-white p-4 max-h-64 overflow-auto z-50 border-t-4 border-purple-500">
                                <div className="flex items-center justify-between mb-3">
                                    <h3 className="text-lg font-semibold">🔧 Developer Panel</h3>
                                    <button 
                                        onClick={() => setShowDevPanel(false)}
                                        className="text-purple-300 hover:text-white"
                                    >
                                        ✕
                                    </button>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                    <div>
                                        <h4 className="font-medium mb-2">Quick Actions</h4>
                                        <div className="space-y-2">
                                            <button 
                                                onClick={() => { setRealData(null); Logger.debug('DEV', 'Cleared all data'); }}
                                                className="block w-full text-left px-3 py-1 bg-red-600 rounded hover:bg-red-700 text-sm"
                                            >
                                                Clear Data
                                            </button>
                                            <button 
                                                onClick={() => { setError('Test error message from dev panel'); Logger.debug('DEV', 'Triggered test error'); }}
                                                className="block w-full text-left px-3 py-1 bg-orange-600 rounded hover:bg-orange-700 text-sm"
                                            >
                                                Trigger Error
                                            </button>
                                            <button 
                                                onClick={() => { setLoading(true); setTimeout(() => setLoading(false), 3000); Logger.debug('DEV', 'Triggered loading state'); }}
                                                className="block w-full text-left px-3 py-1 bg-blue-600 rounded hover:bg-blue-700 text-sm"
                                            >
                                                Test Loading (3s)
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h4 className="font-medium mb-2">Data Export</h4>
                                        <div className="space-y-2">
                                            <button 
                                                onClick={() => {
                                                    const config = JSON.stringify(DASHBOARD_CONFIG, null, 2);
                                                    const blob = new Blob([config], { type: 'application/json' });
                                                    const url = URL.createObjectURL(blob);
                                                    const a = document.createElement('a');
                                                    a.href = url;
                                                    a.download = 'dashboard-config.json';
                                                    a.click();
                                                    URL.revokeObjectURL(url);
                                                    Logger.debug('DEV', 'Exported dashboard config');
                                                }}
                                                className="block w-full text-left px-3 py-1 bg-green-600 rounded hover:bg-green-700 text-sm"
                                            >
                                                Export Config
                                            </button>
                                            <button 
                                                onClick={() => {
                                                    const data = JSON.stringify(realData, null, 2);
                                                    const blob = new Blob([data], { type: 'application/json' });
                                                    const url = URL.createObjectURL(blob);
                                                    const a = document.createElement('a');
                                                    a.href = url;
                                                    a.download = 'dashboard-data.json';
                                                    a.click();
                                                    URL.revokeObjectURL(url);
                                                    Logger.debug('DEV', 'Exported dashboard data');
                                                }}
                                                className="block w-full text-left px-3 py-1 bg-green-600 rounded hover:bg-green-700 text-sm"
                                            >
                                                Export Data
                                            </button>
                                            <button 
                                                onClick={Logger.exportLogs}
                                                className="block w-full text-left px-3 py-1 bg-green-600 rounded hover:bg-green-700 text-sm"
                                            >
                                                Export Logs
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h4 className="font-medium mb-2">System Info</h4>
                                        <div className="text-xs space-y-1">
                                            <div>React: {React.version}</div>
                                            <div>Charts: {ChartsAvailable ? '✅ Loaded' : '❌ Failed'}</div>
                                            <div>Scenario: {currentScenario}</div>
                                            <div>Mode: {isProductionMode ? 'Production' : 'Demo'}</div>
                                            <div>Data: {realData ? '✅ Loaded' : '❌ None'}</div>
                                            <div>Error: {error ? '❌ Yes' : '✅ None'}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Logs Panel */}
                        {showLogs && (
                            <div className="fixed top-16 right-4 w-96 max-h-96 bg-gray-900 text-white p-4 overflow-auto z-50 rounded-lg shadow-xl">
                                <div className="flex items-center justify-between mb-3">
                                    <h3 className="text-lg font-semibold">📋 Debug Logs</h3>
                                    <div className="flex space-x-2">
                                        <button 
                                            onClick={() => {
                                                Logger.clearLogs();
                                                alert('Logs cleared');
                                            }}
                                            className="text-gray-400 hover:text-white text-sm"
                                        >
                                            Clear
                                        </button>
                                        <button 
                                            onClick={() => setShowLogs(false)}
                                            className="text-gray-400 hover:text-white"
                                        >
                                            ✕
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="space-y-1 text-xs font-mono">
                                    {Logger.getLogs().slice(-20).map((log, index) => (
                                        <div key={index} className={`p-1 rounded ${
                                            log.category.startsWith('ERROR') ? 'bg-red-900 text-red-200' :
                                            log.category === 'PERFORMANCE' ? 'bg-blue-900 text-blue-200' :
                                            log.category === 'STATE' ? 'bg-green-900 text-green-200' :
                                            'bg-gray-800 text-gray-300'
                                        }`}>
                                            <div className="font-bold">[{log.category}] {log.message}</div>
                                            {log.data && (
                                                <div className="ml-2 text-gray-400">
                                                    {typeof log.data === 'object' ? JSON.stringify(log.data, null, 2) : log.data}
                                                </div>
                                            )}
                                            <div className="text-gray-500 text-xs">
                                                {new Date(log.timestamp).toLocaleTimeString()}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                
                                {Logger.getLogs().length === 0 && (
                                    <div className="text-gray-500 text-center py-4">No logs yet</div>
                                )}
                            </div>
                        )}

                    </div>
                </div>
            );
        };

        // Error boundary component
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                console.error('React Error Boundary caught an error:', error, errorInfo);
                this.setState({
                    error: error,
                    errorInfo: errorInfo
                });
                
                // Log to our logging system if available
                if (typeof Logger !== 'undefined') {
                    Logger.error('REACT', 'Component error boundary triggered', {
                        error: {
                            message: error.message,
                            stack: error.stack,
                            name: error.name
                        },
                        errorInfo: errorInfo
                    });
                }
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-red-50 p-8">
                            <div className="max-w-4xl mx-auto">
                                <div className="bg-white border border-red-200 rounded-lg p-6">
                                    <h1 className="text-2xl font-bold text-red-800 mb-4">
                                        🚨 Dashboard Error
                                    </h1>
                                    <p className="text-red-700 mb-4">
                                        The dashboard encountered an unexpected error and couldn't render properly.
                                    </p>
                                    
                                    <div className="bg-red-100 border border-red-300 rounded p-4 mb-4">
                                        <h3 className="font-bold text-red-800 mb-2">Error Details:</h3>
                                        <pre className="text-xs text-red-900 overflow-auto">
                                            {this.state.error && this.state.error.toString()}
                                        </pre>
                                    </div>
                                    
                                    <div className="bg-gray-100 border border-gray-300 rounded p-4 mb-4">
                                        <h3 className="font-bold text-gray-800 mb-2">Stack Trace:</h3>
                                        <pre className="text-xs text-gray-900 overflow-auto">
                                            {this.state.error && this.state.error.stack}
                                        </pre>
                                    </div>
                                    
                                    <div className="space-y-2">
                                        <button 
                                            onClick={() => window.location.reload()} 
                                            className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                                        >
                                            Reload Dashboard
                                        </button>
                                        <button 
                                            onClick={() => {
                                                sessionStorage.clear();
                                                localStorage.clear();
                                                window.location.reload();
                                            }} 
                                            className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 ml-2"
                                        >
                                            Clear All Data & Reload
                                        </button>
                                    </div>
                                    
                                    <div className="mt-6 text-sm text-gray-600">
                                        <p><strong>For Claude debugging:</strong></p>
                                        <ol className="list-decimal ml-4 mt-2">
                                            <li>Check browser console for additional errors</li>
                                            <li>Open browser DevTools (F12) → Console tab</li>
                                            <li>Refresh the page and capture any error messages</li>
                                            <li>Check Network tab for failed resource loads</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        // Add global error handler
        window.addEventListener('error', function(event) {
            console.error('Global error caught:', event.error);
            if (typeof Logger !== 'undefined') {
                Logger.error('GLOBAL', 'Unhandled JavaScript error', {
                    message: event.message,
                    filename: event.filename,
                    lineno: event.lineno,
                    colno: event.colno,
                    error: event.error ? {
                        message: event.error.message,
                        stack: event.error.stack,
                        name: event.error.name
                    } : null
                });
            }
        });

        // Add unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            if (typeof Logger !== 'undefined') {
                Logger.error('PROMISE', 'Unhandled promise rejection', {
                    reason: event.reason,
                    promise: event.promise
                });
            }
        });

        // Load Recharts and render the app with error boundary
        console.log('Charts available:', ChartsAvailable);
        console.log('React version:', React.version);
        console.log('ReactDOM available:', typeof ReactDOM);
        
        try {
            ReactDOM.render(
                <ErrorBoundary>
                    <JiraAnalyticsApp />
                </ErrorBoundary>, 
                document.getElementById('root')
            );
            console.log('App successfully mounted');
        } catch (error) {
            console.error('Failed to mount React app:', error);
            document.getElementById('root').innerHTML = `
                <div style="padding: 20px; background: #fee; border: 1px solid #fcc; margin: 20px;">
                    <h2 style="color: #c00;">Failed to Load Dashboard</h2>
                    <p>Error: ${error.message}</p>
                    <p>Check browser console for details.</p>
                    <button onclick="window.location.reload()" style="padding: 10px; background: #007cba; color: white; border: none; border-radius: 4px;">
                        Reload Page
                    </button>
                </div>
            `;
        }
    </script>
</body>
</html>